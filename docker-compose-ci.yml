# Remove the version line (it's obsolete)
services:
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins-ci
    ports:
      - "8083:8080"
    volumes:
      - jenkins_data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker  # Map Docker binary
      - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose  # Map docker-compose
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
    user: root  # Run as root to access Docker
    command: >
      bash -c "
        # Install Maven
        apt-get update &&
        apt-get install -y maven &&
        
        # Fix Docker permissions
        chmod 666 /var/run/docker.sock &&
        
        # Start Jenkins
        /usr/local/bin/jenkins.sh
      "
  sonarqube:
    image: sonarqube:community
    container_name: sonarqube-ci
    ports:
      - "9001:9000"  # CHANGED PORT
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true

  nexus:
    image: sonatype/nexus3
    container_name: nexus-ci
    ports:
      - "8084:8081"  # CHANGED PORT

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer-ci
    ports:
      - "9002:9000"  # CHANGED PORT
    volumes:
      - //var/run/docker.sock:/var/run/docker.sock

volumes:
  jenkins_data: